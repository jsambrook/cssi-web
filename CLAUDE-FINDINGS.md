# Code Review Findings

**Date:** 2026-02-16
**Reviewer:** Claude Opus 4.6
**Scope:** Full codebase review of cssi-web (Astro 5 static site)
**Build:** Clean — 66 pages, zero lint errors, zero format violations

---

## Fixed Since Last Review

| Finding                                  | Fixed In                                         |
| ---------------------------------------- | ------------------------------------------------ |
| Footer phone numbers not clickable       | `Footer.astro:98-103` — now `<a href="tel:...">` |
| IntakeForm placeholder hospital-specific | `intakeForm.ts:118` — now `you@example.com`      |
| Unused `--input` CSS variable            | Removed from `tokens.css`                        |
| ManualInsight type not in types.ts       | `types.ts:98-106` — imported in manualInsights   |
| Orphaned OG image (the-discharge-trap)   | Deleted from `public/images/blog/`               |

---

## Medium

### 1. Future-dated posts accessible via direct URL

**File:** `src/pages/insights/[slug].astro:6`

The slug route filters only `!data.draft`, not `isPublished()`. Three posts dated 2026-02-17 are excluded from listings, tag pages, and RSS (those all call `isPublished()`), but their individual pages are built and reachable at:

- `/insights/quality-illusion-medtech`
- `/insights/why-agile-fails-in-hardware-and-what-actually-works`
- `/insights/workforce-planning-beyond-ftes`

Anyone with the URL can read them before the intended publish date.

**Fix:** Add `isPublished(data.date)` to the `getStaticPaths` filter:

```typescript
const posts = await getCollection('blog', ({ data }) => !data.draft && isPublished(data.date));
```

**Trade-off:** This prevents preview-by-URL for scheduled posts. If preview is needed, keep the current behavior and treat it as intentional.

### 2. Blog post uses personal email address

**File:** `src/content/blog/the-cath-lab-is-empty-at-2am.md:93`

Post says "You can reach me at john@common-sense.com" but the canonical contact email is `contact@common-sense.com` (defined in `src/data/site.ts`).

**Fix:** Change to `contact@common-sense.com`, or confirm `john@` is intentional for this personal post.

### 3. Logo SVG fill colors don't match --primary

**File:** `src/components/Logo.astro:36,41`

The SVG uses two hardcoded fills (`#ff821c` and `#ff7628`) while `--primary` in `tokens.css` is `#fe811b`. Three different oranges for the same brand.

In dark mode the SVG uses `fill-current` (correct), but in light mode the hardcoded values drift from the design token.

**Fix:** Unify the SVG fills with the `--primary` value. SVG `fill` attributes don't support CSS variables, so either:

- Replace the hardcoded hex values with `#fe811b`, or
- Use `class="fill-primary"` (Tailwind maps to `--primary`)

---

## Low

### 4. IntakeForm textarea code path has no visible label

**File:** `src/components/IntakeForm.astro:119-131`

The `inputType === 'text'` branch renders a `<textarea>` with `aria-label` but no visible `<label>` element. The email step (lines 85-101) has visible labels. Currently unreachable — no step in `intakeForm.ts` uses `inputType: 'text'` — but inconsistent if activated.

**Fix:** Add a visible `<label>` before the textarea, or remove the dead code path.

### 5. Footer address not in semantic element

**File:** `src/components/Footer.astro:126`

The address renders inside a `<div class="whitespace-pre-line">`. Semantic HTML would use `<address>`.

**Fix:** Change `<div>` to `<address>` (retaining the class).

### 6. og:image:type hardcoded as PNG

**File:** `src/layouts/BaseLayout.astro:82`

```html
<meta property="og:image:type" content="image/png" />
```

All OG images are currently PNG (generated by `scripts/generate-og-images.js`), so this is correct today. Would be wrong if a page ever passes a JPG `ogImage` prop.

**Fix:** Derive the type from the image extension, or remove the line (the tag is optional).

### 7. Tag page breadcrumb missing Insights level

**File:** `src/layouts/PageLayout.astro:26-29`

PageLayout always builds a 2-level breadcrumb: Home -> Current Page. Tag pages at `/insights/tag/healthcare` get Home -> `Posts tagged "Healthcare"`, missing the intermediate Insights breadcrumb.

BlogPostLayout correctly builds a 3-level breadcrumb (Home -> Insights -> Post title).

**Fix:** Accept an optional `breadcrumbItems` prop in PageLayout, or add Insights as an intermediate item for the tag route.

### 8. IntakeForm redundant variable assignment

**File:** `src/components/IntakeForm.astro:226`

```javascript
const stepEl = step; // step is already the element
```

`stepEl` is identical to `step`. Minor dead assignment.

### 9. Four draft posts have empty body content

**Files:**

- `decision-making-frameworks-for-hospital-leaders.md`
- `community-benefit-measurement.md`
- `financial-transparency-governance.md`
- `joint-fact-finding-in-divided-organizations.md`

Correctly filtered from all listings (`draft: true`). Housekeeping note only.

---

## Summary

| #   | Finding                                    | Severity | Effort  |
| --- | ------------------------------------------ | -------- | ------- |
| 1   | Future-dated posts accessible via URL      | Medium   | Trivial |
| 2   | Blog post personal email vs canonical      | Medium   | Trivial |
| 3   | Logo SVG fills drift from --primary        | Medium   | Small   |
| 4   | IntakeForm textarea missing visible label  | Low      | Small   |
| 5   | Footer address not semantic `<address>`    | Low      | Trivial |
| 6   | og:image:type hardcoded as PNG             | Low      | Trivial |
| 7   | Tag page breadcrumb missing Insights level | Low      | Small   |
| 8   | IntakeForm redundant variable assignment   | Low      | Trivial |
| 9   | Empty draft posts                          | Low      | Trivial |

---

## False Positives Eliminated

These were raised by explore agents but verified as incorrect or by-design:

- **Section.astro heading always h2** — All Section usages appear after an `<h1>` in the page template, so `<h2>` is the correct heading level in every case.
- **IntakeForm not wrapped in `<form>` element** — By design. It's a client-side multi-step wizard that submits via `fetch()`, not a traditional form. No `<form>` element is needed.
- **IntakeForm email regex too permissive** — The regex `/^[^\s@]+@[^\s@]+\.[^\s@]+$/` is standard for client-side pre-validation. The `type="email"` attribute adds browser-native validation, and Formspree validates server-side.
- **ResultsSection hardcoded Tailwind colors** — The `bg-red-50`, `bg-green-50`, `bg-orange-100`, `bg-blue-100` classes on lines 89/95/112/139 are semantic illustration colors (conflict diagram, insight card icons), not brand colors. Using design tokens here would couple illustration semantics to the brand theme.
- **ResultsSection missing null check on getManualInsight()** — The function throws on missing slugs (fail-fast at build time). This is correct behavior per project conventions.
- **Hero smooth scroll fails silently for missing targets** — When `document.querySelector(href)` returns null, `e.preventDefault()` is not called, so the browser falls back to default anchor behavior. Correct progressive enhancement.
- **IndustryToggle data attributes could break on special chars** — Astro automatically escapes HTML attributes.
- **Header mobile focus trap applied globally** — The handler checks `aria-expanded !== 'true'` before intercepting Tab, so it only activates when the mobile menu is open.
