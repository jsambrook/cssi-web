---
/*
 * BaseLayout.astro
 *
 * The root layout for all pages. Includes:
 * - HTML document structure
 * - Meta tags and SEO
 * - CSS imports
 * - Header and Footer
 */

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  ogImageAlt?: string;
  ogType?: string;
  noindex?: boolean;
  articleMeta?: {
    publishedTime: string;
    modifiedTime?: string;
    author?: string;
    tags?: string[];
  };
  jsonLd?: Record<string, unknown>[];
}

import '../assets/css/tokens.css';
import { siteConfig } from '../data/site';
import JsonLd from '../components/JsonLd.astro';
import { buildOrganizationSchema } from '../data/schema';
import { toSeoTitle, toSeoDescription } from '../utils/seo';

const {
  title,
  description = siteConfig.defaultDescription,
  ogImage = siteConfig.defaultOgImage,
  ogImageAlt,
  ogType = 'website',
  noindex = false,
  articleMeta,
  jsonLd = [],
} = Astro.props;

const canonicalURL = Astro.site ? new URL(Astro.url.pathname, Astro.site) : Astro.url;
const ogImageURL = Astro.site ? new URL(ogImage, Astro.site).href : ogImage;
const seoTitle = toSeoTitle(title);
const seoDescription = toSeoDescription(description);
const resolvedOgImageAlt = ogImageAlt ?? `${siteConfig.name} preview image`;
const robotsContent = noindex ? 'noindex, nofollow' : 'index, follow, max-image-preview:large';
const articleTags = articleMeta?.tags?.filter(Boolean) ?? [];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href={siteConfig.font.googleFontsUrl} rel="stylesheet" />

    <!-- Primary Meta Tags -->
    <title>{seoTitle}</title>
    <meta name="description" content={seoDescription} />
    <meta name="author" content={articleMeta?.author ?? siteConfig.name} />
    <meta name="robots" content={robotsContent} />
    <link rel="canonical" href={canonicalURL} />
    <link rel="sitemap" type="application/xml" href="/sitemap-index.xml" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={ogType} />
    <meta property="og:locale" content="en_US" />
    <meta property="og:site_name" content={siteConfig.name} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={seoTitle} />
    <meta property="og:description" content={seoDescription} />
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:image:alt" content={resolvedOgImageAlt} />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    {
      ogType === 'article' && articleMeta && (
        <>
          <meta property="article:published_time" content={articleMeta.publishedTime} />
          <meta
            property="article:modified_time"
            content={articleMeta.modifiedTime ?? articleMeta.publishedTime}
          />
          {articleMeta.author && <meta property="article:author" content={articleMeta.author} />}
          {articleTags.map((tag) => (
            <meta property="article:tag" content={tag} />
          ))}
        </>
      )
    }

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content={siteConfig.xHandle} />
    <meta name="twitter:creator" content={siteConfig.xHandle} />
    <meta name="twitter:title" content={seoTitle} />
    <meta name="twitter:description" content={seoDescription} />
    <meta name="twitter:image" content={ogImageURL} />
    <meta name="twitter:image:alt" content={resolvedOgImageAlt} />

    <!-- Geo -->
    <meta name="geo.region" content="US-WA" />
    <meta name="geo.placename" content="Kirkland, Washington" />
    <meta name="geo.position" content="47.6769;-122.2060" />
    <meta name="ICBM" content="47.6769, -122.2060" />

    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MWXX5J9NWB"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MWXX5J9NWB');
    </script>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title={siteConfig.name} href="/rss.xml" />

    <!-- Structured Data -->
    <JsonLd schemas={[buildOrganizationSchema(), ...jsonLd]} />

    <!-- Dark mode: apply before render to prevent FOUC -->
    <script is:inline>
      (function () {
        const theme = localStorage.getItem('theme');
        if (
          theme === 'dark' ||
          (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)
        ) {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
  </head>
  <body class="min-h-screen flex flex-col">
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:z-[100] focus:p-4 focus:bg-primary focus:text-primary-foreground"
    >
      Skip to content
    </a>

    <slot name="header">
      <!-- Default header - can be overridden -->
    </slot>

    <main id="main-content" class="flex-1">
      <slot />
    </main>

    <slot name="footer">
      <!-- Default footer - can be overridden -->
    </slot>
  </body>
</html>
