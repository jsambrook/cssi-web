---
/*
 * BlogPostLayout.astro
 *
 * Layout for individual blog/insights posts.
 * Wraps rendered markdown content with site chrome.
 */

interface Props {
  title: string;
  description: string;
  date: Date;
  updatedDate?: Date;
  author: string;
  tags?: string[];
  ogImage?: string;
  metaTitle?: string;
  metaDescription?: string;
  wordCount?: number;
}

import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Section from '../components/Section.astro';
import { getPageTitle, headerDefaults, footerDefaults } from '../data/pageDefaults';
import { buildArticleSchema, buildBreadcrumbSchema } from '../data/schema';
import { siteConfig } from '../data/site';
import { tagHref } from '../utils/tags';
import { toPacificIso, formatDate } from '../utils/dates';

const {
  title,
  description,
  date,
  updatedDate,
  author,
  tags = [],
  ogImage,
  metaTitle,
  metaDescription,
  wordCount,
} = Astro.props;
const formattedDate = formatDate(date);
const pacificDateIso = toPacificIso(date);
const pacificModifiedIso = toPacificIso(updatedDate ?? date);
const articleUrl = new URL(Astro.url.pathname, Astro.site).href;
const imageUrl = ogImage ? `${siteConfig.siteUrl}${ogImage}` : undefined;
const articleSchema = buildArticleSchema({
  title,
  description,
  datePublished: pacificDateIso,
  dateModified: pacificModifiedIso,
  author,
  url: articleUrl,
  image: imageUrl,
  tags,
  wordCount,
});
const displayAuthor = author === 'John Sambrook' ? 'John Sambrook, TOC Jonah Certified' : author;
const breadcrumb = buildBreadcrumbSchema([
  { name: 'Home', href: '/' },
  { name: 'Insights', href: '/insights' },
  { name: title, href: Astro.url.pathname },
]);
const articleMeta = {
  publishedTime: pacificDateIso,
  modifiedTime: pacificModifiedIso,
  author,
  tags,
};
---

<BaseLayout
  title={metaTitle ?? getPageTitle(title)}
  description={metaDescription ?? description}
  ogImage={ogImage}
  ogImageAlt={`Open Graph image for ${title}`}
  ogType="article"
  articleMeta={articleMeta}
  jsonLd={[articleSchema, breadcrumb]}
>
  <Header slot="header" {...headerDefaults} currentPath={Astro.url.pathname} />

  <Section>
    <article class="max-w-3xl mx-auto">
      <header class="mb-8 space-y-4">
        <a href="/insights" class="text-sm text-primary hover:text-primary/80"
          >&larr; Back to Insights</a
        >
        <h1 class="text-4xl sm:text-5xl">{title}</h1>
        <p class="text-muted-foreground">{description}</p>
        <div class="text-sm text-muted-foreground">
          <span>{displayAuthor}</span> &middot; <time datetime={pacificDateIso}
            >{formattedDate}</time
          >
        </div>
        {
          tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {tags.map((tag) => (
                <a
                  href={tagHref(tag)}
                  class="text-xs border border-primary/30 text-primary rounded-full px-3 py-0.5 hover:bg-primary/10 transition-colors"
                >
                  {tag}
                </a>
              ))}
            </div>
          )
        }
      </header>
      <div class="prose prose-lg max-w-none">
        <slot />
      </div>
    </article>
  </Section>

  <Footer slot="footer" {...footerDefaults} />
</BaseLayout>
