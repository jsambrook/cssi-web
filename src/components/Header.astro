---
/*
 * Header.astro
 *
 * Sticky navigation header with logo and navigation links.
 * Height: 102px
 *
 * Props:
 *   navItems: Array of {label, href} objects
 *   ctaText: Text for CTA button (optional)
 *   ctaHref: Link for CTA button (optional)
 *   currentPath: Current page path for active nav highlighting
 */

import Logo from './Logo.astro';

interface NavItem {
  label: string;
  href: string;
}

interface Props {
  navItems: NavItem[];
  ctaText?: string;
  ctaHref?: string;
  currentPath?: string;
}

const { navItems, ctaText, ctaHref, currentPath } = Astro.props;
const instanceId = `header-${crypto.randomUUID().slice(0, 8)}`;
const mobileMenuId = `${instanceId}-mobile-menu`;

function isActive(href: string): boolean {
  if (!currentPath) return false;
  if (href === '/') return currentPath === '/';
  return currentPath.startsWith(href);
}
---

<header class="sticky top-0 z-50 w-full bg-background shadow-sm" data-header-root>
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex h-[102px] items-center justify-between">
      <!-- Logo -->
      <a href="/" class="flex items-center">
        <Logo />
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-8">
        <nav class="flex items-center gap-8">
          {
            navItems.map((item, index) => (
              <a
                href={item.href}
                class:list={[
                  'font-medium transition-colors hover:text-primary',
                  isActive(item.href) ? 'text-primary' : 'text-foreground/80',
                ]}
                aria-current={isActive(item.href) ? 'page' : undefined}
              >
                {item.label}
              </a>
            ))
          }
        </nav>

        <!-- Dark Mode Toggle (Desktop) -->
        <button
          data-theme-toggle
          type="button"
          aria-label="Switch to dark mode"
          class="inline-flex items-center justify-center rounded-button transition-all
                 hover:bg-accent/10 size-[42px] text-foreground/80 hover:text-primary"
        >
          <!-- Sun icon (shown in dark mode) -->
          <svg
            class="hidden dark:block h-5 w-5"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <!-- Moon icon (shown in light mode) -->
          <svg
            class="block dark:hidden h-5 w-5"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>

        {
          ctaText && ctaHref && (
            <a
              href={ctaHref}
              class="inline-flex items-center justify-center gap-2 whitespace-nowrap
                   rounded-button transition-all bg-primary text-primary-foreground
                   hover:bg-primary/90 shadow-sm h-[42px] px-6 py-2"
              {...(ctaHref.startsWith('http')
                ? { target: '_blank', rel: 'noopener noreferrer' }
                : {})}
            >
              {ctaText}
            </a>
          )
        }
      </div>

      <!-- Mobile Menu Button -->
      <button
        data-mobile-menu-toggle
        aria-label="Toggle menu"
        aria-expanded="false"
        aria-controls={mobileMenuId}
        class="inline-flex items-center justify-center rounded-button transition-all
               hover:bg-accent/10 size-[54px] md:hidden"
      >
        <svg
          class="h-5 w-5"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <line x1="4" x2="20" y1="12" y2="12"></line>
          <line x1="4" x2="20" y1="6" y2="6"></line>
          <line x1="4" x2="20" y1="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Menu (hidden by default) -->
  <div id={mobileMenuId} data-mobile-menu class="hidden md:hidden border-t border-border/20">
    <div class="container mx-auto px-4 py-4 space-y-2">
      {
        navItems.map((item, index) => (
          <a
            href={item.href}
            class:list={[
              'block py-2 font-medium hover:text-primary',
              isActive(item.href) ? 'text-primary' : 'text-foreground/80',
            ]}
            aria-current={isActive(item.href) ? 'page' : undefined}
          >
            {item.label}
          </a>
        ))
      }

      <!-- Dark Mode Toggle (Mobile) -->
      <button
        data-theme-toggle
        type="button"
        aria-label="Switch to dark mode"
        class="flex items-center gap-3 w-full py-2 font-medium text-foreground/80 hover:text-primary transition-colors"
      >
        <!-- Sun icon (shown in dark mode) -->
        <svg
          class="hidden dark:block h-5 w-5"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <!-- Moon icon (shown in light mode) -->
        <svg
          class="block dark:hidden h-5 w-5"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <span class="dark:hidden">Dark mode</span>
        <span class="hidden dark:inline">Light mode</span>
      </button>

      {
        ctaText && ctaHref && (
          <a
            href={ctaHref}
            class="block mt-4 text-center rounded-button bg-primary text-primary-foreground
                 py-3 px-6 hover:bg-primary/90"
            {...(ctaHref.startsWith('http')
              ? { target: '_blank', rel: 'noopener noreferrer' }
              : {})}
          >
            {ctaText}
          </a>
        )
      }
    </div>
  </div>
</header>

<script>
  function updateThemeLabels(toggles: NodeListOf<HTMLButtonElement>, isDark: boolean) {
    const label = isDark ? 'Switch to light mode' : 'Switch to dark mode';
    toggles.forEach((button) => button.setAttribute('aria-label', label));
  }

  function toggleTheme(toggles: NodeListOf<HTMLButtonElement>) {
    const isDark = document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    updateThemeLabels(toggles, isDark);
  }

  document.querySelectorAll<HTMLElement>('[data-header-root]').forEach((header) => {
    const toggle = header.querySelector<HTMLButtonElement>('[data-mobile-menu-toggle]');
    const menu = header.querySelector<HTMLElement>('[data-mobile-menu]');
    const menuLinks = menu?.querySelectorAll<HTMLAnchorElement>('a');
    const themeToggles = header.querySelectorAll<HTMLButtonElement>('[data-theme-toggle]');

    toggle?.addEventListener('click', () => {
      const menuIsNowHidden = menu?.classList.toggle('hidden');
      const menuIsNowOpen = !menuIsNowHidden;
      toggle.setAttribute('aria-expanded', String(menuIsNowOpen));

      if (menuIsNowOpen) {
        const firstLink = menu?.querySelector<HTMLAnchorElement>('a');
        firstLink?.focus();
      }
    });

    menuLinks?.forEach((link) => {
      link.addEventListener('click', () => {
        menu?.classList.add('hidden');
        toggle?.setAttribute('aria-expanded', 'false');
        toggle?.focus();
      });
    });

    header.addEventListener('keydown', (e: KeyboardEvent) => {
      if (toggle?.getAttribute('aria-expanded') !== 'true') return;

      const focusable = menu?.querySelectorAll<HTMLElement>('a, button');
      if (!focusable?.length) return;
      const lastItem = focusable[focusable.length - 1];

      if (e.key === 'Escape') {
        e.preventDefault();
        menu?.classList.add('hidden');
        toggle?.setAttribute('aria-expanded', 'false');
        toggle?.focus();
        return;
      }

      if (e.key !== 'Tab') return;

      if (e.shiftKey && document.activeElement === toggle) {
        e.preventDefault();
        lastItem.focus();
      } else if (!e.shiftKey && document.activeElement === lastItem) {
        e.preventDefault();
        toggle?.focus();
      }
    });

    updateThemeLabels(themeToggles, document.documentElement.classList.contains('dark'));
    themeToggles.forEach((button) =>
      button.addEventListener('click', () => toggleTheme(themeToggles))
    );
  });
</script>
